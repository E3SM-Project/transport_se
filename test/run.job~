#!/bin/tcsh -f 
#PBS -l walltime=0:10:00
#PBS -j oe
#PBS -l nodes=35:ppn=4    
#PBS -A FY081407


set HOMME = ~/codes/transport_se     # location of HOMME source code and test cases
set wdir = ~/scratch1/transport_se   # directory for building and running

set input = $HOMME/test/           # this test case
set vcoord = $HOMME/test/vcoord    # location of vertical coordinate files
set bld = $wdir/bld

# machine specific CMAKE settings:
set MACH = $HOMME/cmake/machineFiles/redsky.cmake

# set resolution

set nlev = 64     # number of vertical layers (dont change)
set NE = 8        # horizontal resolution   NE=8 is 4 degree (ultra-low-res).  NE=120 is 1/4 degree
set qsize = 60    # number of tracers.  Might be reduced for ACME v1


#######################################################################
# Configure the build (only do this once)
#######################################################################
mkdir -p $bld
cd $bld
set exe = $bld/src/preqx/preqx
if ( 0 ) then
  echo "running CMAKE to configure the model"
  rm -rf CMakeFiles CMakeCache.txt src
  cmake -C $MACH -DQSIZE_D=$qsize -DPREQX_PLEV=$nlev -DPREQX_NP=4  \
   -DPREQX_USE_PIO=TRUE         \
   -DBUILD_HOMME_SWDGX=FALSE                     \
   -DBUILD_HOMME_SWEQX=FALSE                     \
   -DBUILD_HOMME_PRIMDGX=FALSE                   \
   $HOMME
  make -j4 clean
endif

#######################################################################
# compile the code
#######################################################################
make -j4 preqx
if ($status) exit


# low res for debugging
if ( $NE == 8 ) then
   # 3.75 degree    
   set tstep = 1440  
   set nu = 2e16
endif
# ACME target resolution.  
if ( $NE == 120 ) then
   # 0.25 degree
   set tstep = 75
   set nu = 1e13
endif



# number of hours between calls to prim_printstate
set sfreq = 12
@ sfreq *= 3600
@ sfreq /= $tstep
if ( $sfreq == 0 ) set sfreq = 1


set name = setran

# create working directory
mkdir -p $wdir/$name/movies
set wdir = $wdir/$name
cd $wdir
cp -a $vcoord vcoord

# create the namelist (input file) based on parameters set above
cd $input
rm -f $wdir/explicit.nl
sed s/NE/$NE/ explicit.nl.sed |\
sed s/TSTEP/"$tstep"/ |\
sed s/SFREQ/$sfreq/ |\
sed s/NU1/$nu/   > $wdir/input.nl



set NCPU = 4
echo using NCPU = $NCPU
cd $wdir
date
mpirun  $exe  <  input.nl
date

exit

ncl ~/ncl/test.3-$rindex-56.lon-p-cross-section.ncl \
    'fnam="movies/asp_tracer1.nc"' 'pfmt="pdf"'
ncl ~/ncl/test.3-$rindex-56.lat-p-cross-section.ncl \
    'fnam="movies/asp_tracer1.nc"'   'pfmt="pdf"'
ncl ~/cjncl/test.3-0-56.lat-p-cross-section.linear_pressure.ncl \
  'fnam="movies/asp_tracer1.nc"' 'pfmt="pdf"' 'tracer="Q1"'





